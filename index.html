<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador BIM com Medi√ß√£o de √Çngulo e Dist√¢ncia</title>
    
    <link id="modeStylesheet" rel="stylesheet" href="styles.css">
    
    <script type="module" src="https://cdn.jsdelivr.net/npm/@xeokit/xeokit-sdk@latest/dist/xeokit-sdk.min.es.js"></script>
</head>
<body>
    <div id="modelSelection" class="model-selection" role="dialog" aria-modal="true" aria-labelledby="modelSelectionTitle">
        <div class="model-selection-card">
            <h1 id="modelSelectionTitle">Selecione o Projeto</h1>
            <p>Escolha qual grupo de arquivos XKT deseja carregar.</p>
            <div class="model-selection-actions">
                <div class="model-selection-group">
                    <span class="model-selection-group-title">P√∫blico</span>
                    <div class="model-selection-buttons">
                        <button id="selectIperModels" type="button">IPER</button>
                        <button id="selectLacenModels" type="button">LACEN</button>
                    </div>
                </div>
                <div class="model-selection-group">
                    <span class="model-selection-group-title">Privado</span>
                    <div class="model-selection-buttons">
                        <button id="selectFarmaciaModels" type="button">Farm√°cia do J√¢nio</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <canvas id="meuCanvas"></canvas>

    <canvas id="myNavCubeCanvas"></canvas>

    <div id="toolbar" aria-expanded="false">
        <button
            id="btnAngle"
            class="tool-button"
            onclick="setMeasurementMode('angle', this)"
            title="Medir √Çngulo (Transferidor)"
    >
            <span style="font-size: 1.2em;">üìê</span>
            √Çngulo
        </button>

        <button 
            id="btnDistance" 
            class="tool-button" 
            onclick="setMeasurementMode('distance', this)" 
            title="Medir Dist√¢ncia (R√©gua)"
        >
            <span style="font-size: 1.2em;">üìè</span>
            Dist√¢ncia
        </button>
     
        <button 
             id="btnToggleTree"
            class="tool-button"
            onclick="toggleTreeView()"
            title="Mostrar/Esconder Pavimentos"
        >
            <span style="font-size: 1.2em;">üè¢</span>
            Pavimentos
        </button>

        <button
            id="btnSectionPlane"
            class="tool-button"
            onclick="toggleSectionPlane(this)"
            title="Plano de Corte (Horizontal)"
        >
            <span style="font-size: 1.2em;">üî™</span>
            Corte
        </button>
        <button
            id="btnTransformPanel"
            class="tool-button"
            title="Ajustar origem e rota√ß√£o do modelo"
        >
            <span style="font-size: 1.2em;">üß≠</span>
            Origem/Rota√ß√£o
        </button>
        <button
            id="btnCollisionPanel"
            class="tool-button"
            title="Detectar colis√µes entre modelos"
        >
            <span style="font-size: 1.2em;">üßä</span>
            Colis√µes
        </button>
        <button
            id="btnSearchToggle"
            class="tool-button"
            title="Mostrar/Esconder busca por ID"
            aria-pressed="false"
        >
            <span style="font-size: 1.2em;">üîç</span>
            Buscar
        </button>
        <button
            id="btnHelp"
            class="tool-button"
            title="Ajuda e atalhos de teclado"
        >
            <span style="font-size: 1.2em;">‚ùî</span>
            Ajuda
        </button>
    </div>
    <div id="searchBar" class="search-bar" aria-label="Buscar pe√ßa por ID" hidden>
        <label class="sr-only" for="searchIdInput">ID da pe√ßa</label>
        <input id="searchIdInput" type="text" placeholder="Buscar pe√ßa pelo ID" aria-label="ID da pe√ßa" />
        <button id="btnSearchId" type="button">Buscar</button>
        <span id="searchFeedback" class="search-feedback" aria-live="polite"></span>
    </div>
    <button id="mobileToolbarToggle" type="button" aria-label="Mostrar todas as ferramentas" title="Mostrar todas as ferramentas" hidden>
        ‚ò∞ Mais ferramentas
    </button>
    <div id="treeViewContainer"></div>
    <div id="helpPanel" hidden>
        <div class="help-panel-header">
            <div>
                <div class="help-panel-title">Ajuda</div>
                <div class="help-panel-subtitle">Atalhos de teclado e dicas r√°pidas</div>
            </div>
            <button id="closeHelpPanel" type="button" aria-label="Fechar painel de ajuda">‚úï</button>
        </div>

        <div class="help-section">
            <h4>Atalhos gerais</h4>
            <ol class="help-list">
                <li><kbd>1</kbd> ‚Äî Vista da direita</li>
                <li><kbd>2</kbd> ‚Äî Vista da frente</li>
                <li><kbd>3</kbd> ‚Äî Vista da esquerda</li>
                <li><kbd>4</kbd> ‚Äî Vista de tr√°s</li>
                <li><kbd>5</kbd> ‚Äî Vista do topo</li>
                <li><kbd>6</kbd> ‚Äî Vista de baixo</li>
                <li><kbd>Q</kbd> ‚Äî Girar para a esquerda</li>
                <li><kbd>E</kbd> ‚Äî Girar para a direita</li>
                <li><kbd>W</kbd> ‚Äî Aumentar zoom</li>
                <li><kbd>S</kbd> ‚Äî Diminuir zoom</li>
                <li><kbd>Z</kbd> ‚Äî Descer</li>
                <li><kbd>X</kbd> ‚Äî Subir</li>
                <li><kbd>M</kbd> ‚Äî Mostrar todos</li>
                <li><kbd>R</kbd> ‚Äî Redefinir modo raio X</li>
                <li><kbd>Esc</kbd> ‚Äî Sair</li>
            </ol>
        </div>

        <div class="help-section">
            <h4>Para objetos selecionados</h4>
            <ul class="help-list">
                <li><kbd>P</kbd> ‚Äî Propriedades do material</li>
                <li><kbd>I</kbd> ‚Äî Isolar</li>
                <li><kbd>O</kbd> ‚Äî Ocultar</li>
            </ul>
            <p class="help-note">Para selecionar um objeto, clique duas vezes.</p>
        </div>
    </div>
    <div id="collisionPanel" hidden>
        <div class="collision-panel-header">
            <div>
                <div class="collision-panel-title">Verificar colis√µes</div>
                <div class="collision-panel-subtitle">Encontre objetos em conflito dentro de um √∫nico modelo XKT</div>
            </div>
            <button id="closeCollisionPanel" type="button" aria-label="Fechar painel">‚úï</button>
        </div>

        <label class="collision-label" for="collisionModelA">Modelo</label>
        <select id="collisionModelA" aria-label="Modelo para analisar"></select>

        <div class="collision-actions">
            <button type="button" id="runCollisionCheck">Procurar colis√µes</button>
            <button type="button" id="downloadCollisionPdf" disabled>Baixar PDF das colis√µes</button>
        </div>

        <p id="collisionSummary" class="collision-summary">Carregue um modelo para iniciar a an√°lise.</p>
        <ul id="collisionResults" class="collision-results" aria-live="polite"></ul>
    </div>
    <div id="transformPanel" hidden>
        <div class="transform-panel-header">
            <div>
                <div class="transform-panel-title">Origem & Rota√ß√£o</div>
                <div class="transform-panel-subtitle">Reposicione um modelo XKT fora da origem</div>
            </div>
            <button id="closeTransformPanel" type="button" aria-label="Fechar painel">‚úï</button>
        </div>

        <label class="transform-label" for="transformModelSelect">Modelo</label>
        <select id="transformModelSelect" aria-label="Escolha o modelo para ajustar"></select>

        <div class="transform-grid">
            <label class="transform-field">
                Deslocamento X (m)
                <input type="number" id="offsetX" step="0.1" value="0" />
            </label>
            <label class="transform-field">
                Deslocamento Y (m)
                <input type="number" id="offsetY" step="0.1" value="0" />
            </label>
            <label class="transform-field">
                Deslocamento Z (m)
                <input type="number" id="offsetZ" step="0.1" value="0" />
            </label>
        </div>

        <div class="transform-grid">
            <label class="transform-field">
                Rota√ß√£o Y (¬∞)
                <input type="number" id="rotationY" step="1" value="0" />
            </label>
        </div>

        <div class="transform-actions">
            <button type="button" id="applyTransformButton">Aplicar</button>
            <button type="button" id="resetTransformButton">Restaurar origem</button>
        </div>

        <p class="transform-hint">A transla√ß√£o muda a origem do modelo; a rota√ß√£o √© aplicada em torno dessa origem.</p>
    </div>
    <div id="modeSwitcher" aria-label="Alternar modo de visualiza√ß√£o">
        <button type="button" class="mode-button active" data-mode="desktop">Vers√£o Computador</button>
        <button type="button" class="mode-button" data-mode="mobile">Vers√£o Celular</button>
    </div>
    <div id="creditNote" role="note" aria-label="Respons√°vel pelo programa">
        Respons√°vel pelo programa: Rodrigo Damasceno Nascimento
    </div>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script type="module" src="app.js"></script>
    <script>
        const modeStylesheet = document.getElementById('modeStylesheet');
        const modeButtons = document.querySelectorAll('#modeSwitcher [data-mode]');
        const toolbar = document.getElementById('toolbar');
        const mobileToolbarToggle = document.getElementById('mobileToolbarToggle');

        const MOBILE_LABELS = {
            open: '‚¨Ü Minimizar ferramentas',
            closed: '‚ò∞ Mais ferramentas'
        };

        function updateMobileLabels(isOpen) {
            const label = isOpen ? MOBILE_LABELS.open : MOBILE_LABELS.closed;
            toolbar.dataset.label = label;
            mobileToolbarToggle.textContent = label;
            mobileToolbarToggle.setAttribute('aria-label', label);
            mobileToolbarToggle.setAttribute('title', label);
        }

        function toggleMobileToolbar(forceOpen) {
            const shouldOpen = typeof forceOpen === 'boolean' ? forceOpen : !toolbar.classList.contains('open');
            toolbar.classList.toggle('open', shouldOpen);
            toolbar.setAttribute('aria-expanded', shouldOpen ? 'true' : 'false');
            mobileToolbarToggle.setAttribute('aria-pressed', shouldOpen ? 'true' : 'false');
            updateMobileLabels(shouldOpen);
        }
        function applyMode(mode) {
            if (mode !== 'mobile' && mode !== 'desktop') {
                mode = 'desktop';
            }            let stylesheet = 'styles.css';

            if (mode === 'mobile') {
                stylesheet = 'styles-mobile.css';
            }
            if (modeStylesheet.getAttribute('href') !== stylesheet) {
                modeStylesheet.setAttribute('href', stylesheet);
            }
            modeButtons.forEach((button) => {
                button.classList.toggle('active', button.dataset.mode === mode);
            });

            document.body.dataset.mode = mode;

            const isMobileMode = mode === 'mobile';
            mobileToolbarToggle.hidden = !isMobileMode;
            toggleMobileToolbar(false);


            localStorage.setItem('preferredMode', mode);
        }

        modeButtons.forEach((button) => {
            button.addEventListener('click', () => applyMode(button.dataset.mode));
        });

        mobileToolbarToggle.addEventListener('click', () => toggleMobileToolbar());

        toolbar.addEventListener('click', (event) => {
            if (document.body.dataset.mode !== 'mobile') {
                return;
            }

            const clickedButton = event.target.closest('.tool-button');
            const isOpen = toolbar.classList.contains('open');
            const isHeaderClick = !clickedButton && event.target === toolbar;

            if (!isOpen && !clickedButton) {
                event.preventDefault();
                event.stopPropagation();
                toggleMobileToolbar(true);
                return;
            }
            if (!isOpen && clickedButton) {
                toggleMobileToolbar(true);
                return;
            }

            if (isOpen && isHeaderClick) {
                event.preventDefault();
                toggleMobileToolbar(false);
            }
        });
        
        document.addEventListener('click', (event) => {
            if (document.body.dataset.mode !== 'mobile') {
                return;
            }
            const isToolbarClick = toolbar.contains(event.target);
            const isToggleClick = mobileToolbarToggle.contains(event.target);

            if (toolbar.classList.contains('open') && !isToolbarClick && !isToggleClick) {
                toggleMobileToolbar(false);
            }
        });

        updateMobileLabels(false);
        applyMode(localStorage.getItem('preferredMode') || 'desktop');
    </script>
</body>
</html>



